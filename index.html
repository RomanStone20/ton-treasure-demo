<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>TON Treasure Hunt ‚Äî Mini App v3.2</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=2.0, user-scalable=yes">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
  body {margin:0;padding:0;background:#0a0a0a;font-family:'Press Start 2P',sans-serif;color:#fff;overflow:hidden;max-width:390px;margin:0 auto;height:100vh;display:flex;flex-direction:column;}
  #header {background:#111;padding:12px;text-align:center;border-bottom:3px solid #0088ff;font-size:16px;}
  #balance {font-size:18px;}
  #mapContainer {flex:1;overflow:auto;background:#000;position:relative;-webkit-overflow-scrolling:touch;} /* –¥–ª—è smooth touch */
  #grid {display:grid;grid-template-columns:repeat(35,18px);gap:1px;background:#222;margin:15px auto;touch-action:manipulation;} /* touch-action –¥–ª—è —Ç–æ—á–Ω—ã—Ö —Ç–∞–ø–æ–≤ */
  .cell {width:18px;height:18px;display:flex;align-items:center;justify-content:center;font-size:12px;cursor:pointer;position:relative;border:0.5px solid #333;user-select:none;}
  .fog {background:#111;}
  .revealed {background:#3a3;}
  .forest {background:#252;}
  .treasure {background:#ff0;color:#000;font-weight:bold;box-shadow:0 0 8px #ff0;}
  .player {position:absolute;width:14px;height:14px;border-radius:50%;border:1.5px solid #fff;z-index:10;font-size:8px;display:flex;align-items:center;justify-content:center;}
  #log {height:150px;overflow-y:auto;background:#111;padding:10px;font-size:12px;line-height:1.4;border-top:3px solid #0088ff;}
  button {background:#0088ff;color:white;border:none;padding:15px 20px;margin:6px;border-radius:6px;font-family:inherit;font-size:14px;cursor:pointer;min-width:100px;}
  button:active {background:#00aaff;}
</style>
</head>
<body>
<div id="header">
  <div>–ë–∞–ª–∞–Ω—Å: <b><span id="balance">10.00</span></b> TON</div>
</div>

<div id="mapContainer">
  <div id="grid"></div>
</div>

<div style="padding:10px;background:#111;display:flex;flex-wrap:wrap;justify-content:center;gap:8px;">
  <button onclick="deposit()">+10 TON</button>
  <button onclick="simulateBots()">–•–æ–¥ –±–æ—Ç–æ–≤</button>
  <button onclick="simulateJointMove()">–°–æ–≤–º–µ—Å—Ç–Ω—ã–π —Ö–æ–¥ (–¥–µ–ª–µ–Ω–∏–µ)</button>
  <button onclick="withdrawPrompt()">–í—ã–≤–µ—Å—Ç–∏</button>
</div>

<div id="log">–î–µ–º–æ v3.2 –≥–æ—Ç–æ–≤–∞!<br>–ö–ª–∏–∫–Ω–∏ –ª—é–±—É—é –∫–ª–µ—Ç–∫—É ‚Üí –≤–æ–π–¥–∏ –∑–∞ 1 TON.<br>–°–æ–∫—Ä–æ–≤–∏—â–∞ –≤–∏–¥–Ω—ã —Å—Ä–∞–∑—É –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∫–ª–µ—Ç–∫–∏!</div>

<script>
// ====================== TELEGRAM INIT ======================
const tg = window.Telegram.WebApp;
tg.expand();
tg.ready();
tg.setHeaderColor('#111111');
tg.setBackgroundColor('#0a0a0a');

// ====================== –ò–ì–†–ê ======================
const SIZE = 35;
let balance = 10.0;
let totalSpent = 0.0;
let spawned = false;
let playerPos = {x:-1, y:-1};

let players = [
  {name:'–¢—ã', pos:{x:-1,y:-1}, color:'#00f'},
  {name:'Bot1', pos:{x:5,y:5}, color:'#f00'},
  {name:'Bot2', pos:{x:20,y:10}, color:'#0f0'},
  {name:'Bot3', pos:{x:15,y:25}, color:'#ff0'}
];

let revealed = new Set();
let treasures = {};
let foundTreasures = new Set();
const discoveryPercents = [2,3,1,4,5,6,7,8,9,10,12,18]; // 85%
let discoveredOrder = 0;

const treasurePos = [[3,3],[8,15],[25,4],[15,22],[6,27],[28,12],[10,7],[27,27],[12,30],[30,5],[18,18],[5,32]];

// –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
function init() {
  treasurePos.forEach(p => treasures[`${p[0]},${p[1]}`] = true);
  createGrid();
  updateGrid();
  updateUI();
  log('‚úÖ –ú–∏–Ω–∏-–∞–ø–ø v3.2 –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –≤ Telegram! –£–¥–æ–±–Ω–æ –¥–ª—è –ø–∞–ª—å—Ü–µ–≤.');
}

function createGrid() {
  const grid = document.getElementById('grid');
  grid.style.gridTemplateColumns = `repeat(${SIZE}, 18px)`;
  grid.innerHTML = '';
  for (let y = 0; y < SIZE; y++) {
    for (let x = 0; x < SIZE; x++) {
      const cell = document.createElement('div');
      cell.className = 'cell fog';
      cell.dataset.x = x;
      cell.dataset.y = y;
      cell.addEventListener('click', () => handleClick(x, y));
      cell.addEventListener('touchstart', () => handleClick(x, y), {passive: true}); // –¥–ª—è touch
      grid.appendChild(cell);
    }
  }
}

function updateGrid() {
  document.querySelectorAll('.cell').forEach(cell => {
    const x = +cell.dataset.x, y = +cell.dataset.y;
    const key = `${x},${y}`;
    const isRev = revealed.has(key);
    const hasTreasure = treasures[key] && !foundTreasures.has(key);

    cell.classList.toggle('fog', !isRev);
    cell.classList.toggle('revealed', isRev && !hasTreasure);
    cell.classList.toggle('treasure', isRev && hasTreasure);

    cell.innerHTML = (isRev && hasTreasure) ? 'üíé' : '';

    // –∏–≥—Ä–æ–∫–∏
    cell.querySelectorAll('.player').forEach(p => p.remove());
  });

  players.forEach(p => {
    if (p.pos.x < 0) return;
    const cell = document.querySelector(`.cell[data-x="${p.pos.x}"][data-y="${p.pos.y}"]`);
    if (cell) {
      const el = document.createElement('div');
      el.className = 'player';
      el.style.backgroundColor = p.color;
      el.textContent = p.name[0];
      cell.appendChild(el);
    }
  });
}

// –õ–û–ì–ò–ö–ê
function revealAround(x, y) {
  for (let dx = -1; dx <= 1; dx++) {
    for (let dy = -1; dy <= 1; dy++) {
      const nx = x + dx, ny = y + dy;
      if (nx >= 0 && nx < SIZE && ny >= 0 && ny < SIZE) revealed.add(`${nx},${ny}`);
    }
  }
}

function handleClick(x, y) {
  const key = `${x},${y}`;
  if (!spawned) {
    if (balance < 1) return alert('–ù—É–∂–Ω–æ 1 TON –¥–ª—è –≤—Ö–æ–¥–∞');
    if (!confirm('–í–æ–π—Ç–∏? 1 TON')) return;
    balance -= 1; totalSpent += 1;
    spawned = true;
    playerPos = {x, y};
    players[0].pos = {x, y};
    revealAround(x, y);
    updateUI(); updateGrid();
    log(`–¢—ã –∑–∞—Å–ø–∞–≤–Ω–∏–ª—Å—è (${x},${y})`);
    checkTreasure(x, y);
    return;
  }

  const dx = Math.abs(x - playerPos.x);
  const dy = Math.abs(y - playerPos.y);
  if (dx <= 1 && dy <= 1 && !(dx===0 && dy===0)) {
    if (balance < 0.01) return alert('–ù—É–∂–Ω–æ 0.01 TON');
    if (!confirm('–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å—Å—è? 0.01 TON')) return;
    balance -= 0.01; totalSpent += 0.01;
    playerPos = {x, y};
    players[0].pos = {x, y};
    revealAround(x, y);
    updateUI(); updateGrid();
    log(`–ü–µ—Ä–µ—Ö–æ–¥ ‚Üí (${x},${y})`);
    checkTreasure(x, y);
  } else alert('–¢–æ–ª—å–∫–æ —Å–æ—Å–µ–¥–Ω–∏–µ –∫–ª–µ—Ç–∫–∏!');
}

function checkTreasure(x, y) {
  const key = `${x},${y}`;
  if (!treasures[key] || foundTreasures.has(key)) return;

  const percent = discoveryPercents[discoveredOrder];
  const value = parseFloat((percent / 100 * totalSpent).toFixed(2));

  if (confirm(`üíé –ö–õ–ê–î –í–ò–î–ï–ù –í–°–ï–ú!\n–¢—ã –≤—Å—Ç–∞–ª –Ω–∞ –Ω–µ–≥–æ!\n–°—É–º–º–∞: ${value} TON\n–ó–∞–±—Ä–∞—Ç—å?`)) {
    balance += value;
    foundTreasures.add(key);
    delete treasures[key];
    discoveredOrder++;
    log(`–¢–´ –ó–ê–ë–†–ê–õ –ö–õ–ê–î +${value} TON (${percent}%)`);
    updateUI(); updateGrid();

    if (Object.keys(treasures).length === 0) alert('üèÜ –í—Å–µ —Å–æ–∫—Ä–æ–≤–∏—â–∞ –Ω–∞–π–¥–µ–Ω—ã!');
  }
}

// –°–ò–ú–£–õ–Ø–¶–ò–Ø
function simulateBots() {
  players.slice(1).forEach(p => {
    const nx = Math.max(0, Math.min(SIZE-1, p.pos.x + (Math.random()>0.5?1:-1)));
    const ny = Math.max(0, Math.min(SIZE-1, p.pos.y + (Math.random()>0.5?1:-1)));
    p.pos.x = nx; p.pos.y = ny;
    revealAround(nx, ny);
  });
  updateGrid();
  log('–ë–æ—Ç—ã —Å–¥–µ–ª–∞–ª–∏ —Ö–æ–¥');
}

function simulateJointMove() {
  log('üî• –°–∏–º—É–ª—è—Ü–∏—è —Å–æ–≤–º–µ—Å—Ç–Ω–æ–≥–æ —Ö–æ–¥–∞...');
  const targetX = 3, targetY = 3; // –ø—Ä–∏–º–µ—Ä –∫–ª–µ—Ç–∫–∏ —Å –∫–ª–∞–¥–æ–º (–∏–∑ treasurePos)
  players.slice(1).forEach((p,i) => {
    p.pos.x = targetX;
    p.pos.y = targetY;
    revealAround(p.pos.x, p.pos.y);
  });
  updateGrid();

  const key = `${targetX},${targetY}`;
  if (treasures[key]) {
    const percent = discoveryPercents[discoveredOrder];
    const value = parseFloat((percent / 100 * totalSpent).toFixed(2));
    const numPlayersOnCell = 3; // —Å–∏–º—É–ª—è—Ü–∏—è 3 –±–æ—Ç–æ–≤ + —Ç—ã (–Ω–æ —Ç–æ–ª—å–∫–æ –±–æ—Ç—ã)
    const share = parseFloat((value / numPlayersOnCell).toFixed(2));
    log(`üíé –ö–ª–∞–¥ –¥–µ–ª–∏—Ç—Å—è –º–µ–∂–¥—É ${numPlayersOnCell} –∏–≥—Ä–æ–∫–∞–º–∏! –ö–∞–∂–¥—ã–π –ø–æ–ª—É—á–∏–ª –ø–æ ${share} TON`);
    balance += share; // —Ç–æ–ª—å–∫–æ —Ç–µ–±–µ –≤ —Å–∏–º—É–ª—è—Ü–∏–∏
    foundTreasures.add(key);
    delete treasures[key];
    discoveredOrder++;
    updateUI(); updateGrid();
  }
}

// UI
function updateUI() {
  document.getElementById('balance').textContent = balance.toFixed(2);
}

function log(msg) {
  const l = document.getElementById('log');
  const t = new Date().toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'});
  l.innerHTML += `<div>[${t}] ${msg}</div>`;
  l.scrollTop = l.scrollHeight;
}

function deposit() { balance += 10; updateUI(); log('+10 TON (—Ç–µ—Å—Ç)'); }

function withdrawPrompt() {
  const s = prompt('–°–∫–æ–ª—å–∫–æ –≤—ã–≤–µ—Å—Ç–∏? –î–æ—Å—Ç—É–ø–Ω–æ: ' + balance.toFixed(2));
  if (s && +s > 0 && +s <= balance) { balance -= +s; updateUI(); log(`–í—ã–≤–µ–¥–µ–Ω–æ ${s} TON`); }
}

init();
</script>
</body>
</html>
