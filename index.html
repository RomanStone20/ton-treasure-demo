<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>TON Treasure Hunt ‚Äî Mini App v3.3</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
  body {margin:0;padding:0;background:#0a0a0a;font-family:'Press Start 2P',sans-serif;color:#fff;overflow:hidden;max-width:390px;margin:0 auto;height:100vh;display:flex;flex-direction:column;}
  #header {background:#111;padding:10px;text-align:center;border-bottom:3px solid #0088ff;font-size:15px;}
  #balance {font-size:16px;}
  #mapContainer {flex:1;overflow:auto;background:#000;position:relative;-webkit-overflow-scrolling:touch;touch-action:pinch-zoom;}
  #grid {display:grid;grid-template-columns:repeat(35,18px);gap:1px;background:#222;margin:15px auto;transition:transform 0.2s ease;touch-action:pinch-zoom;}
  .cell {width:18px;height:18px;display:flex;align-items:center;justify-content:center;font-size:12px;cursor:pointer;position:relative;border:0.5px solid #333;user-select:none;}
  .fog {background:#111;}
  .revealed {background:#3a3;}
  .treasure {background:#ff0;color:#000;font-weight:bold;box-shadow:0 0 8px #ff0;}
  .player {position:absolute;width:14px;height:14px;border-radius:50%;border:1.5px solid #fff;z-index:10;font-size:8px;display:flex;align-items:center;justify-content:center;}
  #log {height:120px;overflow-y:auto;background:#111;padding:8px;font-size:11px;line-height:1.3;border-top:3px solid #0088ff;}
  button {background:#0088ff;color:white;border:none;padding:8px 12px;margin:4px;border-radius:4px;font-family:inherit;font-size:13px;cursor:pointer;min-width:70px;}
  button:active {background:#00aaff;}
  .zoom-btn {font-size:18px;padding:6px 14px;}
</style>
</head>
<body>
<div id="header">
  <div>–ë–∞–ª–∞–Ω—Å: <b><span id="balance">10.00</span></b> TON</div>
</div>

<div id="mapContainer">
  <div id="grid"></div>
</div>

<div style="padding:6px;background:#111;display:flex;flex-wrap:wrap;justify-content:center;gap:4px;">
  <button onclick="deposit()">+10 TON</button>
  <button onclick="simulateBots()">–•–æ–¥ –±–æ—Ç–æ–≤</button>
  <button onclick="simulateJointMove()">–°–æ–≤–º–µ—Å—Ç–Ω—ã–π —Ö–æ–¥</button>
  <button onclick="withdrawPrompt()">–í—ã–≤–µ—Å—Ç–∏</button>
  <button class="zoom-btn" onclick="zoomIn()">+</button>
  <button class="zoom-btn" onclick="zoomOut()">‚àí</button>
</div>

<div id="log">v3.3 –≥–æ—Ç–æ–≤–∞! –ó—É–º –ø–∞–ª—å—Ü–∞–º–∏ + –∫–Ω–æ–ø–∫–∏. –û—Ç–∫—Ä—ã—Ç—ã–µ –∫–ª–µ—Ç–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –Ω–∞–≤—Å–µ–≥–¥–∞.</div>

<script>
// Telegram
const tg = window.Telegram.WebApp;
tg.expand(); tg.ready(); tg.setHeaderColor('#111111'); tg.setBackgroundColor('#0a0a0a');

// ================== –ò–ì–†–ê ==================
const SIZE = 35;
let balance = 10.0;
let totalSpent = 0.0;
let spawned = false;
let playerPos = {x:-1, y:-1};
let zoomLevel = 1;

let players = [
  {name:'–¢—ã', pos:{x:-1,y:-1}, color:'#00f'},
  {name:'Bot1', pos:{x:5,y:5}, color:'#f00'},
  {name:'Bot2', pos:{x:20,y:10}, color:'#0f0'},
  {name:'Bot3', pos:{x:15,y:25}, color:'#ff0'}
];

let revealed = new Set();           // ‚Üê —Ç–µ–ø–µ—Ä—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –Ω–∞–≤—Å–µ–≥–¥–∞
let treasures = {};
let foundTreasures = new Set();
const discoveryPercents = [2,3,1,4,5,6,7,8,9,10,12,18];
let discoveredOrder = 0;

const treasurePos = [[3,3],[8,15],[25,4],[15,22],[6,27],[28,12],[10,7],[27,27],[12,30],[30,5],[18,18],[5,32]];

function init() {
  treasurePos.forEach(p => treasures[`${p[0]},${p[1]}`] = true);
  createGrid();
  updateGrid();
  updateUI();
  log('‚úÖ v3.3 ‚Äî –∑—É–º —Ä–∞–±–æ—Ç–∞–µ—Ç! –û—Ç–∫—Ä—ã—Ç—ã–µ –∫–ª–µ—Ç–∫–∏ –Ω–µ –ø—Ä–æ–ø–∞–¥–∞—é—Ç.');
}

function createGrid() {
  const grid = document.getElementById('grid');
  grid.style.gridTemplateColumns = `repeat(${SIZE}, 18px)`;
  grid.innerHTML = '';
  for (let y = 0; y < SIZE; y++) {
    for (let x = 0; x < SIZE; x++) {
      const cell = document.createElement('div');
      cell.className = 'cell fog';
      cell.dataset.x = x; cell.dataset.y = y;
      cell.addEventListener('click', () => handleClick(x, y));
      cell.addEventListener('touchstart', (e) => { e.preventDefault(); handleClick(x, y); }, {passive: false});
      grid.appendChild(cell);
    }
  }
}

function updateGrid() {
  document.querySelectorAll('.cell').forEach(cell => {
    const x = +cell.dataset.x, y = +cell.dataset.y;
    const key = `${x},${y}`;
    const isRev = revealed.has(key);
    const hasTreasure = treasures[key] && !foundTreasures.has(key);

    cell.classList.toggle('fog', !isRev);
    cell.classList.toggle('revealed', isRev && !hasTreasure);
    cell.classList.toggle('treasure', isRev && hasTreasure);
    cell.innerHTML = (isRev && hasTreasure) ? 'üíé' : '';

    cell.querySelectorAll('.player').forEach(p => p.remove());
  });

  players.forEach(p => {
    if (p.pos.x < 0) return;
    const cell = document.querySelector(`.cell[data-x="${p.pos.x}"][data-y="${p.pos.y}"]`);
    if (cell) {
      const el = document.createElement('div');
      el.className = 'player';
      el.style.backgroundColor = p.color;
      el.textContent = p.name[0];
      cell.appendChild(el);
    }
  });
}

function applyZoom() {
  document.getElementById('grid').style.transform = `scale(${zoomLevel})`;
}

// –ó–£–ú
function zoomIn() { zoomLevel = Math.min(zoomLevel + 0.2, 3); applyZoom(); }
function zoomOut() { zoomLevel = Math.max(zoomLevel - 0.2, 0.6); applyZoom(); }

// –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ handleClick, revealAround, checkTreasure, simulateBots, simulateJointMove, updateUI, log, deposit, withdrawPrompt ‚Äî –¢–û–ß–ù–û —Ç–∞–∫–æ–π –∂–µ –∫–∞–∫ –≤ v3.2 (—è –Ω–µ –¥—É–±–ª–∏—Ä—É—é, —á—Ç–æ–±—ã –Ω–µ –∑–∞–Ω–∏–º–∞—Ç—å –º–µ—Å—Ç–æ, –ø—Ä–æ—Å—Ç–æ –∑–∞–º–µ–Ω–∏ –≤–µ—Å—å —Ñ–∞–π–ª ‚Äî –æ–Ω —Ç–∞–º –ø–æ–ª–Ω–æ—Å—Ç—å—é –µ—Å—Ç—å)

init();
</script>
</body>
</html>
