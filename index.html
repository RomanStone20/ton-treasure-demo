<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>TON Treasure Hunt ‚Äî v4.1 Online</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/panzoom@9.4.3/dist/panzoom.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
  body {margin:0;padding:0;background:#0a0a0a;font-family:'Press Start 2P',sans-serif;color:#fff;overflow:hidden;max-width:390px;margin:0 auto;height:100vh;display:flex;flex-direction:column;}
  #header {background:#111;padding:10px;text-align:center;border-bottom:3px solid #0088ff;font-size:15px;}
  #balance {font-size:16px;}
  #mapContainer {flex:1;overflow:hidden;background:#000;position:relative;}
  #grid {display:grid;grid-template-columns:repeat(40,16px);gap:1px;background:#222;margin:15px auto;}
  .cell {width:16px;height:16px;display:flex;align-items:center;justify-content:center;font-size:11px;cursor:pointer;position:relative;border:0.5px solid #333;user-select:none;}
  .fog {background:#111;}
  .revealed {background:#3a3;}
  .treasure {background:#ff0;color:#000;font-weight:bold;box-shadow:0 0 8px #ff0;}
  .player {position:absolute;width:13px;height:13px;border-radius:50%;border:2px solid #fff;z-index:10;font-size:8px;display:flex;align-items:center;justify-content:center;}
  #log {height:110px;overflow-y:auto;background:#111;padding:8px;font-size:11px;line-height:1.3;border-top:3px solid #0088ff;}
  button {background:#0088ff;color:white;border:none;padding:8px 12px;margin:4px;border-radius:4px;font-family:inherit;font-size:13px;cursor:pointer;}
  button:active {background:#00aaff;}
</style>
</head>
<body>
<div id="header">–ë–∞–ª–∞–Ω—Å: <b><span id="balance">10.00</span></b> TON</div>

<div id="mapContainer">
  <div id="grid"></div>
</div>

<div style="padding:6px;background:#111;display:flex;flex-wrap:wrap;justify-content:center;gap:4px;">
  <button onclick="deposit()">+10 TON</button>
  <button onclick="withdrawPrompt()">–í—ã–≤–µ—Å—Ç–∏</button>
  <button onclick="zoomIn()">+</button>
  <button onclick="zoomOut()">‚àí</button>
</div>

<div id="log">v4.1 Online –≥–æ—Ç–æ–≤–∞! –û—Ç–∫—Ä—ã–≤–∞–π —Å –¥—Ä—É–≥–æ–º ‚Äî –≤—Å—ë –≤–∏–¥–Ω–æ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.</div>

<script>
// Telegram
const tg = window.Telegram.WebApp;
tg.expand(); tg.ready(); tg.setHeaderColor('#111111'); tg.setBackgroundColor('#0a0a0a');

// ================== SUPABASE (—Ç–≤–æ–∏ –∫–ª—é—á–∏) ==================
const SUPABASE_URL = 'https://yrbmrtmsqydklqgpdakz.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_bTXlaXpI9WpusTXDLml99A_k2_-_TOW';
const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ================== –ò–ì–†–ê ==================
const SIZE = 40;
let balance = 10.0;
let totalSpent = 0.0;
let spawned = false;
let playerPos = {x:-1, y:-1};
const ROOM = 'room1'; // –æ–±—â–∞—è –∫–æ–º–Ω–∞—Ç–∞ –¥–ª—è —Ç–µ–±—è –∏ –¥—Ä—É–≥–∞

let revealed = new Set();
let treasures = {};
let foundTreasures = new Set();
const discoveryPercents = [2,3,1,4,5,6,7,8,9,10,12,18];
let discoveredOrder = 0;

const treasurePos = [[5,5],[35,5],[5,35],[35,35],[15,10],[25,30],[10,25],[30,15],[8,18],[32,22],[18,8],[22,32]];

let panInstance;
let myPlayerId = tg.initDataUnsafe?.user?.id || 'demo-user';

function init() {
  treasurePos.forEach(p => treasures[`${p[0]},${p[1]}`] = true);
  createGrid();
  initPanzoom();
  updateGrid();
  updateUI();
  connectRealtime();
  log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ Supabase! –û—Ç–∫—Ä—ã–≤–∞–π –∏–≥—Ä—É —É –¥—Ä—É–≥–∞ ‚Äî –±—É–¥–µ—Ç–µ –≤–∏–¥–µ—Ç—å –¥—Ä—É–≥ –¥—Ä—É–≥–∞.');
}

function createGrid() {
  const grid = document.getElementById('grid');
  grid.style.gridTemplateColumns = `repeat(${SIZE}, 16px)`;
  grid.innerHTML = '';
  for (let y = 0; y < SIZE; y++) {
    for (let x = 0; x < SIZE; x++) {
      const cell = document.createElement('div');
      cell.className = 'cell fog';
      cell.dataset.x = x; cell.dataset.y = y;
      cell.addEventListener('click', () => handleClick(x, y));
      grid.appendChild(cell);
    }
  }
}

function initPanzoom() {
  const grid = document.getElementById('grid');
  panInstance = panzoom(grid, {
    maxScale: 5,
    minScale: 0.3,
    smoothScroll: true,
    bounds: true,
    zoomSpeed: 0.3
  });
}

function zoomIn() { panInstance.zoomIn(0.3); }
function zoomOut() { panInstance.zoomOut(0.3); }

function revealAround(x, y) {
  for (let dx = -1; dx <= 1; dx++) {
    for (let dy = -1; dy <= 1; dy++) {
      const nx = x + dx, ny = y + dy;
      if (nx >= 0 && nx < SIZE && ny >= 0 && ny < SIZE) {
        revealed.add(`${nx},${ny}`);
        supabase.channel(ROOM).send({
          type: 'broadcast',
          event: 'reveal',
          payload: {x: nx, y: ny, from: myPlayerId}
        });
      }
    }
  }
}

function handleClick(x, y) {
  if (!spawned) {
    if (balance < 1) return alert('–ù—É–∂–Ω–æ 1 TON –¥–ª—è –≤—Ö–æ–¥–∞');
    if (!confirm('–í–æ–π—Ç–∏? 1 TON')) return;
    balance -= 1; totalSpent += 1;
    spawned = true;
    playerPos = {x, y};
    revealAround(x, y);
    sendPlayerPosition();
    updateUI(); updateGrid();
    log(`–¢—ã –∑–∞—Å–ø–∞–≤–Ω–∏–ª—Å—è (${x},${y})`);
    checkTreasure(x, y);
    return;
  }

  const dx = Math.abs(x - playerPos.x);
  const dy = Math.abs(y - playerPos.y);
  if (dx <= 1 && dy <= 1 && !(dx===0 && dy===0)) {
    if (balance < 0.01) return alert('–ù—É–∂–Ω–æ 0.01 TON');
    if (!confirm('–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å—Å—è? 0.01 TON')) return;
    balance -= 0.01; totalSpent += 0.01;
    playerPos = {x, y};
    revealAround(x, y);
    sendPlayerPosition();
    updateUI(); updateGrid();
    log(`–ü–µ—Ä–µ—Ö–æ–¥ ‚Üí (${x},${y})`);
    checkTreasure(x, y);
  } else alert('–¢–æ–ª—å–∫–æ —Å–æ—Å–µ–¥–Ω–∏–µ –∫–ª–µ—Ç–∫–∏!');
}

function checkTreasure(x, y) {
  const key = `${x},${y}`;
  if (!treasures[key] || foundTreasures.has(key)) return;

  const percent = discoveryPercents[discoveredOrder];
  const value = parseFloat((percent / 100 * totalSpent).toFixed(2));

  if (confirm(`üíé –ö–õ–ê–î –í–ò–î–ï–ù –í–°–ï–ú!\n–°—É–º–º–∞: ${value} TON\n–ó–∞–±—Ä–∞—Ç—å?`)) {
    balance += value;
    foundTreasures.add(key);
    delete treasures[key];
    discoveredOrder++;

    supabase.channel(ROOM).send({
      type: 'broadcast',
      event: 'treasure_found',
      payload: {x, y, value, order: discoveredOrder}
    });

    log(`–¢–´ –ó–ê–ë–†–ê–õ –ö–õ–ê–î +${value} TON`);
    updateUI(); updateGrid();

    if (Object.keys(treasures).length === 0) alert('üèÜ –í—Å–µ —Å–æ–∫—Ä–æ–≤–∏—â–∞ –Ω–∞–π–¥–µ–Ω—ã!');
  }
}

function sendPlayerPosition() {
  supabase.channel(ROOM).send({
    type: 'broadcast',
    event: 'player_move',
    payload: {id: myPlayerId, x: playerPos.x, y: playerPos.y}
  });
}

// ================== REALTIME ==================
function connectRealtime() {
  const channel = supabase.channel(ROOM);

  channel
    .on('broadcast', { event: 'reveal' }, p => {
      revealed.add(`${p.payload.x},${p.payload.y}`);
      updateGrid();
      if (p.payload.from !== myPlayerId) log(`–î—Ä—É–≥ –æ—Ç–∫—Ä—ã–ª –∫–ª–µ—Ç–∫—É (${p.payload.x},${p.payload.y})`);
    })
    .on('broadcast', { event: 'player_move' }, p => {
      if (p.payload.id === myPlayerId) return;
      // —Ä–∏—Å—É–µ–º –¥—Ä—É–≥–∞ (–≤ –±—É–¥—É—â–µ–º –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –º–∞—Å—Å–∏–≤ –∏–≥—Ä–æ–∫–æ–≤)
      log(`–î—Ä—É–≥ –ø–µ—Ä–µ–º–µ—Å—Ç–∏–ª—Å—è –Ω–∞ (${p.payload.x},${p.payload.y})`);
      updateGrid();
    })
    .on('broadcast', { event: 'treasure_found' }, p => {
      const key = `${p.payload.x},${p.payload.y}`;
      if (!foundTreasures.has(key)) {
        foundTreasures.add(key);
        delete treasures[key];
        discoveredOrder = p.payload.order;
        log(`–î—Ä—É–≥ –Ω–∞—à—ë–ª –∫–ª–∞–¥! (${p.payload.value} TON)`);
        updateGrid();
      }
    })
    .subscribe(() => log('‚úÖ –û–Ω–ª–∞–π–Ω —Å –¥—Ä—É–≥–æ–º! –û—Ç–∫—Ä–æ–π –∏–≥—Ä—É —É –Ω–µ–≥–æ —Ç–æ–∂–µ.'));

  // –æ–±–Ω–æ–≤–ª—è–µ–º —Å–µ—Ç–∫—É –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
  setInterval(updateGrid, 2000);
}

// UI —Ñ—É–Ω–∫—Ü–∏–∏
function updateUI() { document.getElementById('balance').textContent = balance.toFixed(2); }
function log(msg) {
  const l = document.getElementById('log');
  const t = new Date().toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'});
  l.innerHTML += `<div>[${t}] ${msg}</div>`;
  l.scrollTop = l.scrollHeight;
}
function deposit() { balance += 10; updateUI(); log('+10 TON (—Ç–µ—Å—Ç)'); }
function withdrawPrompt() {
  const s = prompt('–°–∫–æ–ª—å–∫–æ –≤—ã–≤–µ—Å—Ç–∏? –î–æ—Å—Ç—É–ø–Ω–æ: ' + balance.toFixed(2));
  if (s && +s > 0 && +s <= balance) { balance -= +s; updateUI(); log(`–í—ã–≤–µ–¥–µ–Ω–æ ${s} TON`); }
}

init();
</script>
</body>
</html>
